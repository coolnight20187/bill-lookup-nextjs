(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{4863:function(){},2963:function(){},9218:function(e,a,t){Promise.resolve().then(t.bind(t,3513))},3513:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return ek}});var s=t(7920),n=t(1335),r=t(6685),l=t(8703),i=t(6767),c=t(3445),o=t(4455),d=t(1220),m=t(7208),u=t(9570),h=t(9283),x=t(7889),p=t(928),f=t(892),g=t(7102),j=t(4993),v=t(1967);let N=p.fC,y=p.xz;p.ZA,p.Uv,p.Tr,p.Ee,n.forwardRef((e,a)=>{let{className:t,inset:n,children:r,...l}=e;return(0,s.jsxs)(p.fF,{ref:a,className:(0,v.cn)("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",n&&"pl-8",t),...l,children:[r,(0,s.jsx)(f.Z,{className:"ml-auto h-4 w-4"})]})}).displayName=p.fF.displayName,n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(p.tu,{ref:a,className:(0,v.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...n})}).displayName=p.tu.displayName;let b=n.forwardRef((e,a)=>{let{className:t,sideOffset:n=4,...r}=e;return(0,s.jsx)(p.Uv,{children:(0,s.jsx)(p.VY,{ref:a,sideOffset:n,className:(0,v.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...r})})});b.displayName=p.VY.displayName;let w=n.forwardRef((e,a)=>{let{className:t,inset:n,...r}=e;return(0,s.jsx)(p.ck,{ref:a,className:(0,v.cn)("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",n&&"pl-8",t),...r})});function _(e){let{user:a}=e,[t,p]=(0,n.useState)(!1),f=(0,r.useRouter)(),{toast:g}=(0,i.pm)(),{setTheme:j}=(0,x.F)(),v=async()=>{p(!0);try{let{error:e}=await c.O.auth.signOut();if(e)throw e;g({title:"Đăng xuất th\xe0nh c\xf4ng",description:"Hẹn gặp lại!"}),f.push("/login")}catch(e){g({title:"Lỗi đăng xuất",description:e.message,variant:"destructive"})}finally{p(!1)}};return(0,s.jsx)("nav",{className:"border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-40",children:(0,s.jsxs)("div",{className:"container flex h-14 items-center",children:[(0,s.jsx)("div",{className:"mr-4 flex",children:(0,s.jsx)("a",{className:"mr-6 flex items-center space-x-2",href:"/dashboard",children:(0,s.jsx)("span",{className:"font-bold text-xl",children:"⚡ Tra cứu Bill (7tỷ.vn)"})})}),(0,s.jsxs)("div",{className:"flex flex-1 items-center justify-between space-x-2 md:justify-end",children:[(0,s.jsx)("div",{className:"w-full flex-1 md:w-auto md:flex-none"}),(0,s.jsxs)("nav",{className:"flex items-center space-x-2",children:[(0,s.jsxs)(N,{children:[(0,s.jsx)(y,{asChild:!0,children:(0,s.jsxs)(l.z,{variant:"outline",size:"sm",children:[(0,s.jsx)(o.Z,{className:"h-4 w-4 mr-2"}),"Giao diện"]})}),(0,s.jsxs)(b,{align:"end",children:[(0,s.jsxs)(w,{onClick:()=>j("light"),children:[(0,s.jsx)(d.Z,{className:"mr-2 h-4 w-4"}),"S\xe1ng"]}),(0,s.jsxs)(w,{onClick:()=>j("dark"),children:[(0,s.jsx)(m.Z,{className:"mr-2 h-4 w-4"}),"Tối"]}),(0,s.jsxs)(w,{onClick:()=>j("system"),children:[(0,s.jsx)(u.Z,{className:"mr-2 h-4 w-4"}),"Tự động"]})]})]}),(0,s.jsxs)("span",{className:"text-sm text-muted-foreground",children:["Ch\xe0o, ",a.full_name||a.username," (",a.role,")!"]}),(0,s.jsxs)(l.z,{variant:"destructive",size:"sm",onClick:v,disabled:t,children:[(0,s.jsx)(h.Z,{className:"h-4 w-4 mr-2"}),"Tho\xe1t"]})]})]})]})})}w.displayName=p.ck.displayName,n.forwardRef((e,a)=>{let{className:t,children:n,checked:r,...l}=e;return(0,s.jsxs)(p.oC,{ref:a,className:(0,v.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),checked:r,...l,children:[(0,s.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,s.jsx)(p.wU,{children:(0,s.jsx)(g.Z,{className:"h-4 w-4"})})}),n]})}).displayName=p.oC.displayName,n.forwardRef((e,a)=>{let{className:t,children:n,...r}=e;return(0,s.jsxs)(p.Rk,{ref:a,className:(0,v.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...r,children:[(0,s.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,s.jsx)(p.wU,{children:(0,s.jsx)(j.Z,{className:"h-2 w-2 fill-current"})})}),n]})}).displayName=p.Rk.displayName,n.forwardRef((e,a)=>{let{className:t,inset:n,...r}=e;return(0,s.jsx)(p.__,{ref:a,className:(0,v.cn)("px-2 py-1.5 text-sm font-semibold",n&&"pl-8",t),...r})}).displayName=p.__.displayName,n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(p.Z0,{ref:a,className:(0,v.cn)("-mx-1 my-1 h-px bg-muted",t),...n})}).displayName=p.Z0.displayName;var k=t(6700),C=t(6292),S=t(9666),T=t(9848),z=t(6784);let Z=S.fC;S.ZA;let O=S.B4,R=n.forwardRef((e,a)=>{let{className:t,children:n,...r}=e;return(0,s.jsxs)(S.xz,{ref:a,className:(0,v.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",t),...r,children:[n,(0,s.jsx)(S.JO,{asChild:!0,children:(0,s.jsx)(T.Z,{className:"h-4 w-4 opacity-50"})})]})});R.displayName=S.xz.displayName;let H=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(S.u_,{ref:a,className:(0,v.cn)("flex cursor-default items-center justify-center py-1",t),...n,children:(0,s.jsx)(z.Z,{className:"h-4 w-4"})})});H.displayName=S.u_.displayName;let E=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(S.$G,{ref:a,className:(0,v.cn)("flex cursor-default items-center justify-center py-1",t),...n,children:(0,s.jsx)(T.Z,{className:"h-4 w-4"})})});E.displayName=S.$G.displayName;let K=n.forwardRef((e,a)=>{let{className:t,children:n,position:r="popper",...l}=e;return(0,s.jsx)(S.h_,{children:(0,s.jsxs)(S.VY,{ref:a,className:(0,v.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===r&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:r,...l,children:[(0,s.jsx)(H,{}),(0,s.jsx)(S.l_,{className:(0,v.cn)("p-1","popper"===r&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:n}),(0,s.jsx)(E,{})]})})});K.displayName=S.VY.displayName,n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(S.__,{ref:a,className:(0,v.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...n})}).displayName=S.__.displayName;let L=n.forwardRef((e,a)=>{let{className:t,children:n,...r}=e;return(0,s.jsxs)(S.ck,{ref:a,className:(0,v.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...r,children:[(0,s.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,s.jsx)(S.wU,{children:(0,s.jsx)(g.Z,{className:"h-4 w-4"})})}),(0,s.jsx)(S.eT,{children:n})]})});L.displayName=S.ck.displayName,n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(S.Z0,{ref:a,className:(0,v.cn)("-mx-1 my-1 h-px bg-muted",t),...n})}).displayName=S.Z0.displayName;let V=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("textarea",{className:(0,v.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...n})});V.displayName="Textarea";var A=t(4489),I=t(257),D=t(6599);let M=[{value:"00906815",label:"Điện lực miền Nam"},{value:"00906819",label:"Điện lực miền Bắc"},{value:"00906818",label:"Điện EVNHCMC"},{value:"00906820",label:"Điện EVN H\xe0 Nội"},{value:"00906817",label:"Điện An Giang"}];function F(e){let{onResults:a}=e,[t,r]=(0,n.useState)("00906815"),[c,o]=(0,n.useState)(""),[d,m]=(0,n.useState)(!1),{toast:u}=(0,i.pm)(),h=async()=>{let e=c.split("\n").map(e=>e.trim()).filter(e=>e.length>5);if(!e.length){u({title:"Lỗi",description:"Vui l\xf2ng nhập m\xe3 kh\xe1ch h\xe0ng.",variant:"destructive"});return}m(!0);let s=[];try{let n=/^\d{8}$/.test(t);for(let r=0;r<e.length;r++){let l=e[r];try{let e,a;if(n)e=await fetch("/api/check-electricity",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contract_number:l,sku:t})});else{if(!/^P[A-Z0-9]{12}$/i.test(l))throw Error("M\xe3 kh\xf4ng hợp lệ cho Cổng 1 (phải l\xe0 PB...)");e=await fetch("/api/get-bill",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({account:l.toUpperCase(),product_id:t})})}if(!e.ok){let a=await e.json();throw Error(a.error||"Lỗi ".concat(e.status))}let r=await e.json();a=n?function(e,a,t){var s;if(e.success&&e.data&&e.data.success&&e.data.data&&e.data.data.bills){if(!(e.data.data.bills.length>0))return{key:"".concat(t,"::").concat(a),account:a,name:"(M\xe3 ".concat(a,")"),address:"Kh\xf4ng nợ cước",amount_current:"0",amount_previous:"0",total:"0",provider_id:t,raw_data:e.data.data};{let s=e.data.data.bills[0];return{key:"".concat(t,"::").concat(a),account:a,name:s.customerName||"-",address:s.address||"-",amount_current:String(s.moneyAmount||"0"),amount_previous:"0",total:String(s.moneyAmount||"0"),provider_id:t,raw_data:e.data.data}}}let n=(null===(s=e.error)||void 0===s?void 0:s.message)||e.details||"Lỗi tra cứu C2";return e.data&&e.data.error&&(n=e.data.error.message||"Lỗi kh\xf4ng x\xe1c định C2"),{key:"".concat(t,"::").concat(a),account:a,name:"(M\xe3 ".concat(a,")"),address:n,amount_current:"0",amount_previous:"0",total:"0",provider_id:t,raw_data:{error:n}}}(r,l,t):function(e,a,t){var s,n;let r=Array.isArray(e.bills)?e.bills:[],l=+e.statement_closing||+(null===(s=r[0])||void 0===s?void 0:s.amount)||0,i=+(null===(n=r[1])||void 0===n?void 0:n.amount)||0,c=+e.total_bill_amount||l;return{key:"".concat(t,"::").concat(a),account:a,name:e.name||"-",address:e.address||"-",amount_current:String(l),amount_previous:String(i),total:String(c),provider_id:t,raw_data:e}}(r,l,t),s.push(a)}catch(e){console.error("Error looking up ".concat(l,":"),e),s.push({key:"".concat(t,"::").concat(l),account:l,name:"(M\xe3 ".concat(l,")"),address:e.message,amount_current:"0",amount_previous:"0",total:"0",provider_id:t,raw_data:{error:e.message}})}a([...s]),r<e.length-1&&await new Promise(e=>setTimeout(e,n?500:2e3))}u({title:"Tra cứu ho\xe0n tất",description:"Đ\xe3 tra cứu ".concat(s.length," m\xe3 kh\xe1ch h\xe0ng.")})}catch(e){u({title:"Lỗi tra cứu",description:e.message,variant:"destructive"})}finally{m(!1)}};return(0,s.jsxs)(k.Zb,{children:[(0,s.jsx)(k.Ol,{children:(0,s.jsxs)(k.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(A.Z,{className:"h-5 w-5"}),"Tra Cứu H\xf3a Đơn"]})}),(0,s.jsxs)(k.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"provider",children:"Nh\xe0 cung cấp:"}),(0,s.jsxs)(Z,{value:t,onValueChange:r,children:[(0,s.jsx)(R,{children:(0,s.jsx)(O,{})}),(0,s.jsx)(K,{children:M.map(e=>(0,s.jsx)(L,{value:e.value,children:e.label},e.value))})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"accounts",children:"M\xe3 kh\xe1ch h\xe0ng (mỗi d\xf2ng một m\xe3):"}),(0,s.jsx)(V,{id:"accounts",value:c,onChange:e=>o(e.target.value),placeholder:"Nhập m\xe3 KH (PB/PA... hoặc số thu\xea bao)",rows:4})]}),(0,s.jsx)("div",{className:"flex gap-2",children:(0,s.jsxs)(l.z,{variant:"outline",onClick:()=>{o(c.split("\n").map(e=>e.trim()).filter((e,a,t)=>e&&t.indexOf(e)===a).join("\n"))},className:"flex-1",children:[(0,s.jsx)(I.Z,{className:"h-4 w-4 mr-2"}),"Lọc tr\xf9ng"]})}),(0,s.jsx)(l.z,{onClick:h,disabled:d,className:"w-full",children:d?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(D.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"Đang tra cứu..."]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(A.Z,{className:"mr-2 h-4 w-4"}),"Tra cứu"]})})]})]})}var B=t(6684),Y=t(6197),P=t(4068);function q(e){let{selectedBills:a,user:t,onWarehouseOpen:r}=e,[o,d]=(0,n.useState)([]),[m,u]=(0,n.useState)(!1),[h,x]=(0,n.useState)(!1),{toast:p}=(0,i.pm)(),f=(0,n.useCallback)(async()=>{try{let{data:e,error:a}=await c.O.from("warehouse").select("*").is("exported_at",null).order("imported_at",{ascending:!1}).limit(5);if(a)throw a;d(e||[])}catch(e){console.error("Error loading warehouse preview:",e)}},[]);(0,n.useEffect)(()=>{f()},[f]);let g=async()=>{if(!a.length){p({title:"Lỗi",description:"Chọn c\xe1c h\xf3a đơn để nhập kho.",variant:"destructive"});return}x(!0);try{let e=a.map(e=>({key:e.key,account:e.account,provider_id:e.provider_id,name:e.name||"-",address:e.address||"-",amount_current:e.amount_current,amount_previous:e.amount_previous,total:e.total,imported_at:new Date().toISOString(),raw_data:e.raw_data})),{data:t,error:s}=await c.O.from("warehouse").upsert(e,{onConflict:"key",ignoreDuplicates:!0}).select();if(s)throw s;p({title:"Nhập kho th\xe0nh c\xf4ng",description:"Đ\xe3 nhập ".concat((null==t?void 0:t.length)||0," h\xf3a đơn v\xe0o kho.")}),f()}catch(e){p({title:"Lỗi nhập kho",description:e.message,variant:"destructive"})}finally{x(!1)}};return(0,s.jsxs)(k.Zb,{children:[(0,s.jsx)(k.Ol,{children:(0,s.jsxs)(k.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(B.Z,{className:"h-5 w-5"}),"Quản l\xfd KHO"]})}),(0,s.jsxs)(k.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(l.z,{onClick:g,disabled:h||!a.length,className:"flex-1",children:[h?(0,s.jsx)(D.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,s.jsx)(Y.Z,{className:"mr-2 h-4 w-4"}),"Nhập v\xe0o KHO"]}),"admin"===t.role&&(0,s.jsx)(l.z,{variant:"destructive",onClick:()=>{p({title:"Chức năng đang ph\xe1t triển",description:"Chọn c\xe1c mục trong bảng để x\xf3a."})},children:(0,s.jsx)(P.Z,{className:"h-4 w-4"})})]}),(0,s.jsxs)(l.z,{variant:"outline",onClick:r,disabled:m,className:"w-full",children:[m?(0,s.jsx)(D.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,s.jsx)(B.Z,{className:"mr-2 h-4 w-4"}),"Mở KHO (",o.length,"+)"]}),o.length>0&&(0,s.jsxs)("div",{className:"max-h-60 overflow-y-auto space-y-2",children:[o.map(e=>(0,s.jsxs)("div",{className:"border rounded p-2 text-sm",children:[(0,s.jsx)("div",{className:"font-medium",children:e.name}),(0,s.jsxs)("div",{className:"text-muted-foreground",children:[e.account," - ",(0,v.lb)(e.total)]}),(0,s.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Nhập: ",(0,v.p6)(e.imported_at)]})]},e.id)),(0,s.jsx)("div",{className:"text-center text-sm text-muted-foreground",children:'... nhấn "Mở KHO" để xem tất cả'})]})]})]})}var X=t(1538),U=t(4078),G=t(6055);let Q=U.fC,$=U.xz,J=U.h_;U.x8;let W=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(U.aV,{ref:a,className:(0,v.cn)("fixed inset-0 z-50 bg-background/80 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...n})});W.displayName=U.aV.displayName;let ee=n.forwardRef((e,a)=>{let{className:t,children:n,...r}=e;return(0,s.jsxs)(J,{children:[(0,s.jsx)(W,{}),(0,s.jsxs)(U.VY,{ref:a,className:(0,v.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...r,children:[n,(0,s.jsxs)(U.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,s.jsx)(G.Z,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});ee.displayName=U.VY.displayName;let ea=e=>{let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,v.cn)("flex flex-col space-y-1.5 text-center sm:text-left",a),...t})};ea.displayName="DialogHeader";let et=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(U.Dx,{ref:a,className:(0,v.cn)("text-lg font-semibold leading-none tracking-tight",t),...n})});et.displayName=U.Dx.displayName,n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(U.dk,{ref:a,className:(0,v.cn)("text-sm text-muted-foreground",t),...n})}).displayName=U.dk.displayName;var es=t(3840),en=t(1862),er=t(2759);function el(e){let{user:a}=e,[t,r]=(0,n.useState)([]),[o,d]=(0,n.useState)(""),[m,u]=(0,n.useState)(null),[h,x]=(0,n.useState)(!1),[p,f]=(0,n.useState)(!1),{toast:g}=(0,i.pm)(),[j,v]=(0,n.useState)({username:"",password:"",role:"user",full_name:"",phone:""}),N=(0,n.useCallback)(async()=>{x(!0);try{let e=c.O.from("employees").select("id, username, role, full_name, phone, is_active").eq("is_active",!0).order("username");o&&(e=e.or("username.ilike.%".concat(o,"%,full_name.ilike.%").concat(o,"%")));let{data:a,error:t}=await e;if(t)throw t;r(a||[])}catch(e){g({title:"Lỗi tải danh s\xe1ch nh\xe2n vi\xean",description:e.message,variant:"destructive"})}finally{x(!1)}},[o,g]);(0,n.useEffect)(()=>{"admin"===a.role&&N()},[a.role,N]);let y=async e=>{if(e.preventDefault(),!j.username||!m&&!j.password){g({title:"Lỗi",description:"Vui l\xf2ng điền đầy đủ th\xf4ng tin bắt buộc.",variant:"destructive"});return}try{if(m){let e={username:j.username,role:j.role,full_name:j.full_name||null,phone:j.phone||null};j.password&&(e.password_hash=j.password);let{error:a}=await c.O.from("employees").update(e).eq("id",m.id);if(a)throw a;g({title:"Cập nhật th\xe0nh c\xf4ng",description:"Th\xf4ng tin nh\xe2n vi\xean đ\xe3 được cập nhật."})}else{let{error:e}=await c.O.from("employees").insert({username:j.username,password_hash:j.password,role:j.role,full_name:j.full_name||null,phone:j.phone||null});if(e)throw e;g({title:"Th\xeam th\xe0nh c\xf4ng",description:"Nh\xe2n vi\xean mới đ\xe3 được th\xeam."})}f(!1),b(),N()}catch(e){g({title:"Lỗi",description:e.message,variant:"destructive"})}},b=()=>{v({username:"",password:"",role:"user",full_name:"",phone:""}),u(null)},w=e=>{u(e),v({username:e.username,password:"",role:e.role,full_name:e.full_name||"",phone:e.phone||""}),f(!0)},_=async e=>{if(confirm('Bạn c\xf3 chắc chắn muốn x\xf3a nh\xe2n vi\xean "'.concat(e.username,'"?')))try{let{error:a}=await c.O.from("employees").update({is_active:!1}).eq("id",e.id);if(a)throw a;g({title:"X\xf3a th\xe0nh c\xf4ng",description:"Nh\xe2n vi\xean đ\xe3 được x\xf3a."}),N()}catch(e){g({title:"Lỗi x\xf3a",description:e.message,variant:"destructive"})}};return"admin"!==a.role?(0,s.jsxs)(k.Zb,{children:[(0,s.jsx)(k.Ol,{children:(0,s.jsxs)(k.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(es.Z,{className:"h-5 w-5"}),"Quản l\xfd Nh\xe2n Vi\xean"]})}),(0,s.jsx)(k.aY,{children:(0,s.jsx)("p",{className:"text-muted-foreground",children:"Chỉ quản trị vi\xean mới c\xf3 quyền truy cập chức năng n\xe0y."})})]}):(0,s.jsxs)(k.Zb,{children:[(0,s.jsx)(k.Ol,{children:(0,s.jsxs)(k.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(es.Z,{className:"h-5 w-5"}),"Quản l\xfd Nh\xe2n Vi\xean"]})}),(0,s.jsxs)(k.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)(X.I,{placeholder:"T\xecm t\xean nh\xe2n vi\xean...",value:o,onChange:e=>d(e.target.value),onKeyDown:e=>"Enter"===e.key&&N()})}),(0,s.jsx)(l.z,{variant:"outline",onClick:N,disabled:h,children:(0,s.jsx)(A.Z,{className:"h-4 w-4"})})]}),(0,s.jsxs)(Q,{open:p,onOpenChange:f,children:[(0,s.jsx)($,{asChild:!0,children:(0,s.jsxs)(l.z,{onClick:b,className:"w-full",children:[(0,s.jsx)(en.Z,{className:"mr-2 h-4 w-4"}),"Th\xeam Nh\xe2n Vi\xean"]})}),(0,s.jsxs)(ee,{className:"max-w-md",children:[(0,s.jsx)(ea,{children:(0,s.jsx)(et,{children:m?"Sửa Nh\xe2n Vi\xean":"Th\xeam Nh\xe2n Vi\xean Mới"})}),(0,s.jsxs)("form",{onSubmit:y,className:"space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"username",children:"T\xean đăng nhập *"}),(0,s.jsx)(X.I,{id:"username",value:j.username,onChange:e=>v({...j,username:e.target.value}),required:!0})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)(C._,{htmlFor:"password",children:["Mật khẩu ",m?"(để trống nếu kh\xf4ng đổi)":"*"]}),(0,s.jsx)(X.I,{id:"password",type:"password",value:j.password,onChange:e=>v({...j,password:e.target.value}),required:!m})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"role",children:"Quyền *"}),(0,s.jsxs)(Z,{value:j.role,onValueChange:e=>v({...j,role:e}),children:[(0,s.jsx)(R,{children:(0,s.jsx)(O,{})}),(0,s.jsxs)(K,{children:[(0,s.jsx)(L,{value:"user",children:"Nh\xe2n Vi\xean"}),(0,s.jsx)(L,{value:"admin",children:"Quản Trị Vi\xean"})]})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"full_name",children:"Họ v\xe0 T\xean"}),(0,s.jsx)(X.I,{id:"full_name",value:j.full_name,onChange:e=>v({...j,full_name:e.target.value})})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"phone",children:"Số điện thoại"}),(0,s.jsx)(X.I,{id:"phone",value:j.phone,onChange:e=>v({...j,phone:e.target.value})})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(l.z,{type:"button",variant:"outline",onClick:()=>f(!1),className:"flex-1",children:"Hủy"}),(0,s.jsx)(l.z,{type:"submit",className:"flex-1",children:m?"Cập nhật":"Th\xeam mới"})]})]})]})]}),h?(0,s.jsx)("div",{className:"flex justify-center py-4",children:(0,s.jsx)(D.Z,{className:"h-6 w-6 animate-spin"})}):(0,s.jsxs)("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:[t.map(e=>(0,s.jsxs)("div",{className:"flex items-center justify-between border rounded p-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-medium",children:e.username}),(0,s.jsxs)("div",{className:"text-sm text-muted-foreground",children:[e.full_name||"Chưa c\xf3 t\xean"," - ",e.role]}),e.phone&&(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.phone})]}),(0,s.jsxs)("div",{className:"flex gap-1",children:[(0,s.jsx)(l.z,{variant:"outline",size:"sm",onClick:()=>w(e),children:(0,s.jsx)(er.Z,{className:"h-3 w-3"})}),(0,s.jsx)(l.z,{variant:"destructive",size:"sm",onClick:()=>_(e),children:(0,s.jsx)(P.Z,{className:"h-3 w-3"})})]})]},e.id)),0===t.length&&(0,s.jsx)("p",{className:"text-center text-muted-foreground py-4",children:"Kh\xf4ng t\xecm thấy nh\xe2n vi\xean n\xe0o."})]})]})]})}var ei=t(5023),ec=t(141),eo=t(5439);function ed(e){let{user:a,selectedBills:t,onSellComplete:r,onHistoryOpen:o}=e,[d,m]=(0,n.useState)([]),[u,h]=(0,n.useState)([]),[x,p]=(0,n.useState)(""),[f,g]=(0,n.useState)(""),[j,v]=(0,n.useState)(null),[N,y]=(0,n.useState)(!1),[b,w]=(0,n.useState)(!1),[_,S]=(0,n.useState)(!1),{toast:T}=(0,i.pm)(),[z,H]=(0,n.useState)({name:"",zalo:"",bank:""}),[E,V]=(0,n.useState)(""),[A,I]=(0,n.useState)(""),M=(0,n.useCallback)(async()=>{y(!0);try{let{data:e,error:a}=await c.O.from("members").select("*").order("name");if(a)throw a;m(e||[])}catch(e){T({title:"Lỗi tải kh\xe1ch h\xe0ng",description:e.message,variant:"destructive"})}finally{y(!1)}},[T]),F=(0,n.useCallback)(()=>{let e=d;x&&(e=d.filter(e=>e.name.toLowerCase().includes(x.toLowerCase()))),h(e)},[d,x]);(0,n.useEffect)(()=>{M()},[M]),(0,n.useEffect)(()=>{F()},[F]);let B=async e=>{if(e.preventDefault(),!z.name){T({title:"Lỗi",description:"T\xean kh\xe1ch h\xe0ng l\xe0 bắt buộc.",variant:"destructive"});return}try{if(j){let{error:e}=await c.O.from("members").update({name:z.name,zalo:z.zalo||null,bank:z.bank||null}).eq("id",j.id);if(e)throw e;T({title:"Cập nhật th\xe0nh c\xf4ng",description:"Th\xf4ng tin kh\xe1ch h\xe0ng đ\xe3 được cập nhật."})}else{let{error:e}=await c.O.from("members").insert({name:z.name,zalo:z.zalo||null,bank:z.bank||null});if(e)throw e;T({title:"Th\xeam th\xe0nh c\xf4ng",description:"Kh\xe1ch h\xe0ng mới đ\xe3 được th\xeam."})}S(!1),Y(),M()}catch(e){T({title:"Lỗi",description:e.message,variant:"destructive"})}},Y=()=>{H({name:"",zalo:"",bank:""}),v(null)},P=e=>{v(e),H({name:e.name,zalo:e.zalo||"",bank:e.bank||""}),S(!0)},q=async()=>{if(!t.length){T({title:"Lỗi",description:"Chọn h\xf3a đơn để b\xe1n.",variant:"destructive"});return}if(!f){T({title:"Lỗi",description:"Chọn kh\xe1ch h\xe0ng thẻ.",variant:"destructive"});return}let e=d.find(e=>e.id===f);if(e){w(!0);try{let s=new Date().toISOString(),n=t.map(t=>({account:t.account,provider_id:t.provider_id,name:t.name,address:t.address,amount_current:t.amount_current,amount_previous:t.amount_previous,total:t.total,imported_at:t.imported_at||s,sold_at:s,member_id:f,member_name:e.name,employee_id:a.id,employee_username:a.username,raw_data:t.raw_data})),{error:l}=await c.O.from("transaction_history").insert(n);if(l)throw l;let i=t.map(e=>e.key),{error:o}=await c.O.from("warehouse").update({exported_at:s}).in("key",i);if(o)throw o;T({title:"B\xe1n h\xe0ng th\xe0nh c\xf4ng",description:"Đ\xe3 b\xe1n ".concat(t.length," h\xf3a đơn cho ").concat(e.name,".")}),null==r||r()}catch(e){T({title:"Lỗi b\xe1n h\xe0ng",description:e.message,variant:"destructive"})}finally{w(!1)}}};return(0,s.jsxs)(k.Zb,{children:[(0,s.jsx)(k.Ol,{children:(0,s.jsxs)(k.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(ei.Z,{className:"h-5 w-5"}),"Kh\xe1ch H\xe0ng & B\xe1n H\xe0ng"]})}),(0,s.jsxs)(k.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("h6",{className:"font-semibold text-sm",children:"Kh\xe1ch H\xe0ng Thẻ"}),"admin"===a.role&&(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(Q,{open:_,onOpenChange:S,children:[(0,s.jsx)($,{asChild:!0,children:(0,s.jsxs)(l.z,{variant:"outline",size:"sm",onClick:Y,className:"flex-1",children:[(0,s.jsx)(en.Z,{className:"mr-2 h-4 w-4"}),"Th\xeam"]})}),(0,s.jsxs)(ee,{className:"max-w-md",children:[(0,s.jsx)(ea,{children:(0,s.jsx)(et,{children:j?"Sửa Kh\xe1ch H\xe0ng":"Th\xeam Kh\xe1ch H\xe0ng Mới"})}),(0,s.jsxs)("form",{onSubmit:B,className:"space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"name",children:"T\xean kh\xe1ch h\xe0ng *"}),(0,s.jsx)(X.I,{id:"name",value:z.name,onChange:e=>H({...z,name:e.target.value}),required:!0})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"zalo",children:"Zalo"}),(0,s.jsx)(X.I,{id:"zalo",value:z.zalo,onChange:e=>H({...z,zalo:e.target.value})})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(C._,{htmlFor:"bank",children:"Ng\xe2n h\xe0ng"}),(0,s.jsx)(X.I,{id:"bank",value:z.bank,onChange:e=>H({...z,bank:e.target.value})})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(l.z,{type:"button",variant:"outline",onClick:()=>S(!1),className:"flex-1",children:"Hủy"}),(0,s.jsx)(l.z,{type:"submit",className:"flex-1",children:j?"Cập nhật":"Th\xeam mới"})]})]})]})]}),(0,s.jsx)(l.z,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>{if(f){let e=d.find(e=>e.id===f);e&&P(e)}else T({title:"Chọn kh\xe1ch h\xe0ng",description:"Vui l\xf2ng chọn kh\xe1ch h\xe0ng để sửa.",variant:"destructive"})},children:(0,s.jsx)(er.Z,{className:"h-4 w-4"})})]}),(0,s.jsx)(X.I,{placeholder:"T\xecm t\xean kh\xe1ch h\xe0ng (Enter)",value:x,onChange:e=>p(e.target.value),onKeyDown:e=>"Enter"===e.key&&F()}),(0,s.jsxs)(Z,{value:f,onValueChange:g,children:[(0,s.jsx)(R,{children:(0,s.jsx)(O,{placeholder:"Chọn kh\xe1ch h\xe0ng thẻ"})}),(0,s.jsx)(K,{children:u.map(e=>(0,s.jsxs)(L,{value:e.id,children:[e.name," (Z:",e.zalo||"N/A",") (B:",e.bank||"N/A",")"]},e.id))})]})]}),(0,s.jsx)("hr",{}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("h6",{className:"font-semibold text-sm",children:"B\xe1n H\xe0ng & Lịch sử"}),(0,s.jsx)(C._,{className:"text-xs",children:"Lọc Bill KHO (Từ → Đến):"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(X.I,{placeholder:"Từ",type:"number",value:E,onChange:e=>V(e.target.value),className:"flex-1"}),(0,s.jsx)(X.I,{placeholder:"Đến",type:"number",value:A,onChange:e=>I(e.target.value),className:"flex-1"}),(0,s.jsx)(l.z,{variant:"outline",size:"sm",children:"Lọc"})]}),(0,s.jsxs)(l.z,{onClick:q,disabled:b||!t.length,className:"w-full",children:[b?(0,s.jsx)(D.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,s.jsx)(ec.Z,{className:"mr-2 h-4 w-4"}),"B\xe1n (",t.length,")"]}),(0,s.jsxs)(l.z,{variant:"outline",className:"w-full",onClick:o,children:[(0,s.jsx)(eo.Z,{className:"mr-2 h-4 w-4"}),"Mở Lịch sử"]})]})]})]})}var em=t(2626);let eu=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("div",{className:"relative w-full overflow-auto",children:(0,s.jsx)("table",{ref:a,className:(0,v.cn)("w-full caption-bottom text-sm",t),...n})})});eu.displayName="Table";let eh=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("thead",{ref:a,className:(0,v.cn)("[&_tr]:border-b",t),...n})});eh.displayName="TableHeader";let ex=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("tbody",{ref:a,className:(0,v.cn)("[&_tr:last-child]:border-0",t),...n})});ex.displayName="TableBody",n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("tfoot",{ref:a,className:(0,v.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...n})}).displayName="TableFooter";let ep=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("tr",{ref:a,className:(0,v.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",t),...n})});ep.displayName="TableRow";let ef=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("th",{ref:a,className:(0,v.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...n})});ef.displayName="TableHead";let eg=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("td",{ref:a,className:(0,v.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...n})});eg.displayName="TableCell",n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("caption",{ref:a,className:(0,v.cn)("mt-4 text-sm text-muted-foreground",t),...n})}).displayName="TableCaption";var ej=t(7353),ev=t(4197),eN=t(2271),ey=t(5567),eb=t(3158),ew=t(2757);function e_(e){let{data:a,onSelectionChange:t,viewMode:r="lookup"}=e,[c,o]=(0,n.useState)([]),[d,m]=(0,n.useState)(new Set),[u,h]=(0,n.useState)(""),[x,p]=(0,n.useState)(!1),[g,j]=(0,n.useState)("list"),[N,y]=(0,n.useState)(1),[b,w]=(0,n.useState)(15),[_,C]=(0,n.useState)(null),{toast:S}=(0,i.pm)(),T=(0,n.useCallback)(()=>{let e=[...a];u&&(e=e.filter(e=>e.name.toLowerCase().includes(u.toLowerCase())||e.address.toLowerCase().includes(u.toLowerCase())||e.account.toLowerCase().includes(u.toLowerCase())||e.employee_username&&e.employee_username.toLowerCase().includes(u.toLowerCase()))),x&&(e=e.filter(e=>(0,v.a6)(e.total)>0)),_&&e.sort((e,a)=>{let t=e[_.key],s=a[_.key];return(("total"===_.key||"amount_current"===_.key||"amount_previous"===_.key)&&(t=(0,v.a6)(t),s=(0,v.a6)(s)),t<s)?"asc"===_.direction?-1:1:t>s?"asc"===_.direction?1:-1:0}),o(e),y(1)},[a,u,x,_]);(0,n.useEffect)(()=>{T()},[T]),(0,n.useEffect)(()=>{t(a.filter(e=>d.has(e.key)))},[d,a,t]);let z=e=>{C(a=>({key:e,direction:(null==a?void 0:a.key)===e&&"asc"===a.direction?"desc":"asc"}))},H=(e,a)=>{let t=new Set(Array.from(d));a?t.add(e):t.delete(e),m(t)},E=()=>{let e=(N-1)*b;return c.slice(e,e+b)},V=async()=>{let e=E().map(e=>[e.name,e.address,e.account,(0,v.lb)(e.amount_previous),(0,v.lb)(e.amount_current),(0,v.lb)(e.total),e.imported_at?(0,v.p6)(e.imported_at):"",e.exported_at?(0,v.p6)(e.exported_at):"",e.member_name||"",e.employee_username||""].join("	")).join("\n");try{await navigator.clipboard.writeText(e),S({title:"Sao ch\xe9p th\xe0nh c\xf4ng",description:"Dữ liệu đ\xe3 được sao ch\xe9p v\xe0o clipboard."})}catch(e){S({title:"Lỗi sao ch\xe9p",description:"Kh\xf4ng thể sao ch\xe9p dữ liệu.",variant:"destructive"})}},I=E(),D=Math.ceil(c.length/b),M=I.reduce((e,a)=>e+(0,v.a6)(a.total),0);return 0===a.length?(0,s.jsx)(k.Zb,{children:(0,s.jsxs)(k.aY,{className:"flex flex-col items-center justify-center py-12",children:[(0,s.jsx)(A.Z,{className:"h-12 w-12 text-muted-foreground mb-4"}),(0,s.jsx)("p",{className:"text-lg font-medium text-muted-foreground",children:"Bắt đầu bằng c\xe1ch tra cứu hoặc mở KHO"})]})}):(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(k.Zb,{children:(0,s.jsxs)(k.aY,{className:"p-4 space-y-4",children:[(0,s.jsxs)("div",{className:"flex gap-4 items-center",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(A.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,s.jsx)(X.I,{placeholder:"T\xecm kiếm trong kết quả...",value:u,onChange:e=>h(e.target.value),className:"pl-10"})]})}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(em.X,{id:"hide-zero",checked:x,onCheckedChange:e=>p(e)}),(0,s.jsx)("label",{htmlFor:"hide-zero",className:"text-sm",children:"Ẩn Bill 0₫"})]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(l.z,{variant:"outline",size:"sm",onClick:()=>{if(0===c.length){S({title:"Kh\xf4ng c\xf3 dữ liệu",description:"Kh\xf4ng c\xf3 dữ liệu để xuất.",variant:"destructive"});return}let e=c.map((e,a)=>({STT:a+1,"T\xean KH":e.name,"Địa chỉ":e.address,"M\xe3 KH":e.account,"Kỳ trước":(0,v.a6)(e.amount_previous)/1e5,"Kỳ n\xe0y":(0,v.a6)(e.amount_current)/1e5,"Tổng cộng":(0,v.a6)(e.total)/1e5,"Ng\xe0y nhập KHO":e.imported_at?(0,v.p6)(e.imported_at):"","Ng\xe0y xuất KHO":e.exported_at?(0,v.p6)(e.exported_at):"","Kh\xe1ch H\xe0ng THẺ":e.member_name||"","Nh\xe2n Vi\xean B\xe1n":e.employee_username||""})),a=ew.P6.json_to_sheet(e),t=ew.P6.book_new();ew.P6.book_append_sheet(t,a,"DanhSachBill"),ew.NC(t,"DanhSachBill-".concat(Date.now(),".xlsx")),S({title:"Xuất file th\xe0nh c\xf4ng",description:"Dữ liệu đ\xe3 được xuất ra file Excel."})},children:[(0,s.jsx)(ej.Z,{className:"h-4 w-4 mr-2"}),"Xuất"]}),(0,s.jsxs)(l.z,{variant:"outline",size:"sm",onClick:V,children:[(0,s.jsx)(ev.Z,{className:"h-4 w-4 mr-2"}),"Sao ch\xe9p"]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(l.z,{variant:"list"===g?"default":"outline",size:"sm",onClick:()=>j("list"),children:(0,s.jsx)(eN.Z,{className:"h-4 w-4"})}),(0,s.jsx)(l.z,{variant:"grid"===g?"default":"outline",size:"sm",onClick:()=>j("grid"),children:(0,s.jsx)(ey.Z,{className:"h-4 w-4"})})]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-sm",children:"Hiển thị:"}),(0,s.jsxs)(Z,{value:b.toString(),onValueChange:e=>w(Number(e)),children:[(0,s.jsx)(R,{className:"w-20",children:(0,s.jsx)(O,{})}),(0,s.jsxs)(K,{children:[(0,s.jsx)(L,{value:"15",children:"15"}),(0,s.jsx)(L,{value:"30",children:"30"}),(0,s.jsx)(L,{value:"50",children:"50"}),(0,s.jsx)(L,{value:"100",children:"100"})]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)("span",{className:"text-sm",children:["Trang ",N," / ",D," (",c.length," mục)"]}),(0,s.jsx)(l.z,{variant:"outline",size:"sm",onClick:()=>y(Math.max(1,N-1)),disabled:1===N,children:(0,s.jsx)(eb.Z,{className:"h-4 w-4"})}),(0,s.jsx)(l.z,{variant:"outline",size:"sm",onClick:()=>y(Math.min(D,N+1)),disabled:N===D,children:(0,s.jsx)(f.Z,{className:"h-4 w-4"})})]})]})]})}),"list"===g?(0,s.jsxs)(k.Zb,{children:[(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)(eu,{children:[(0,s.jsx)(eh,{children:(0,s.jsxs)(ep,{children:[(0,s.jsx)(ef,{className:"w-12",children:(0,s.jsx)(em.X,{checked:I.length>0&&I.every(e=>d.has(e.key)),onCheckedChange:e=>{if(e){let e=E(),a=new Set(Array.from(d));e.forEach(e=>a.add(e.key)),m(a)}else{let e=E(),a=new Set(Array.from(d));e.forEach(e=>a.delete(e.key)),m(a)}}})}),(0,s.jsx)(ef,{onClick:()=>z("name"),className:"cursor-pointer",children:"STT"}),(0,s.jsx)(ef,{onClick:()=>z("name"),className:"cursor-pointer",children:"T\xean KH"}),(0,s.jsx)(ef,{onClick:()=>z("address"),className:"cursor-pointer",children:"Địa chỉ"}),(0,s.jsx)(ef,{onClick:()=>z("account"),className:"cursor-pointer",children:"M\xe3 KH"}),"lookup"===r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(ef,{onClick:()=>z("amount_previous"),className:"cursor-pointer",children:"Kỳ trước"}),(0,s.jsx)(ef,{onClick:()=>z("amount_current"),className:"cursor-pointer",children:"Kỳ n\xe0y"})]}),(0,s.jsx)(ef,{onClick:()=>z("total"),className:"cursor-pointer",children:"Tổng cộng"}),("warehouse"===r||"history"===r)&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(ef,{children:"Ng\xe0y nhập KHO"}),(0,s.jsx)(ef,{children:"Ng\xe0y xuất KHO"})]}),"history"===r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(ef,{children:"Kh\xe1ch H\xe0ng THẺ"}),(0,s.jsx)(ef,{children:"Nh\xe2n Vi\xean B\xe1n"})]})]})}),(0,s.jsx)(ex,{children:I.map((e,a)=>(0,s.jsxs)(ep,{children:[(0,s.jsx)(eg,{children:(0,s.jsx)(em.X,{checked:d.has(e.key),onCheckedChange:a=>H(e.key,a)})}),(0,s.jsx)(eg,{children:(N-1)*b+a+1}),(0,s.jsx)(eg,{children:e.name}),(0,s.jsx)(eg,{children:e.address}),(0,s.jsx)(eg,{children:e.account}),"lookup"===r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eg,{children:(0,v.lb)(e.amount_previous)}),(0,s.jsx)(eg,{children:(0,v.lb)(e.amount_current)})]}),(0,s.jsx)(eg,{className:"font-medium",children:(0,v.lb)(e.total)}),("warehouse"===r||"history"===r)&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eg,{children:e.imported_at?(0,v.p6)(e.imported_at):""}),(0,s.jsx)(eg,{children:e.exported_at?(0,v.p6)(e.exported_at):""})]}),"history"===r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eg,{children:e.member_name||""}),(0,s.jsx)(eg,{children:e.employee_username||""})]})]},e.key))})]})}),(0,s.jsx)("div",{className:"border-t p-4",children:(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("span",{className:"text-sm text-muted-foreground",children:["Đ\xe3 chọn: ",d.size," mục"]}),(0,s.jsxs)("span",{className:"font-medium",children:["Tổng tiền (trang n\xe0y): ",(0,v.lb)(M.toString())]})]})})]}):(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:I.map(e=>(0,s.jsxs)(k.Zb,{className:"cursor-pointer hover:shadow-md transition-shadow",children:[(0,s.jsx)(k.Ol,{className:"pb-2",children:(0,s.jsxs)("div",{className:"flex items-start justify-between",children:[(0,s.jsx)(k.ll,{className:"text-base",children:e.name}),(0,s.jsx)(em.X,{checked:d.has(e.key),onCheckedChange:a=>H(e.key,a)})]})}),(0,s.jsxs)(k.aY,{className:"space-y-2",children:[(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["M\xe3 KH: ",e.account]}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Địa chỉ: ",e.address]}),(0,s.jsx)("p",{className:"text-lg font-bold text-red-600",children:(0,v.lb)(e.total)}),"lookup"===r&&(0,s.jsxs)("p",{className:"text-sm",children:["Kỳ trước: ",(0,v.lb)(e.amount_previous)," | Kỳ n\xe0y: ",(0,v.lb)(e.amount_current)]}),e.imported_at&&(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Nhập: ",(0,v.p6)(e.imported_at)]}),e.exported_at&&(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Xuất: ",(0,v.p6)(e.exported_at)]}),e.member_name&&(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:["KHT: ",e.member_name]}),e.employee_username&&(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:["NV B\xe1n: ",e.employee_username]})]})]},e.key))})]})}function ek(){let[e,a]=(0,n.useState)(null),[t,l]=(0,n.useState)(!0),[i,o]=(0,n.useState)([]),[d,m]=(0,n.useState)([]),[u,h]=(0,n.useState)("lookup"),x=(0,r.useRouter)(),p=(0,n.useCallback)(async()=>{try{var e;let{data:{session:t}}=await c.O.auth.getSession();if(!t){x.push("/login");return}let s=null===(e=t.user.user_metadata)||void 0===e?void 0:e.employee_id;if(s){let{data:e}=await c.O.from("employees").select("*").eq("id",s).eq("is_active",!0).single();e&&a({id:e.id,username:e.username,role:e.role,full_name:e.full_name})}}catch(e){console.error("Auth check error:",e),x.push("/login")}finally{l(!1)}},[x]);(0,n.useEffect)(()=>{p()},[p]);let f=async()=>{try{let{data:e,error:a}=await c.O.from("warehouse").select("*").is("exported_at",null).order("imported_at",{ascending:!1});if(a)throw a;let t=(e||[]).map(e=>({key:e.key,account:e.account,name:e.name||"-",address:e.address||"-",amount_current:e.amount_current,amount_previous:e.amount_previous,total:e.total,provider_id:e.provider_id,raw_data:e.raw_data,imported_at:e.imported_at,exported_at:e.exported_at}));o(t),h("warehouse")}catch(e){console.error("Error loading warehouse:",e)}},g=async()=>{try{let{data:e,error:a}=await c.O.from("transaction_history").select("*").order("sold_at",{ascending:!1});if(a)throw a;let t=(e||[]).map(e=>({key:"".concat(e.provider_id,"::").concat(e.account,"::").concat(e.sold_at),account:e.account,name:e.name||"-",address:e.address||"-",amount_current:e.amount_current,amount_previous:e.amount_previous,total:e.total,provider_id:e.provider_id,raw_data:e.raw_data,imported_at:e.imported_at,exported_at:e.exported_at,member_name:e.member_name,employee_username:e.employee_username}));o(t),h("history")}catch(e){console.error("Error loading history:",e)}};return t?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsx)(D.Z,{className:"h-8 w-8 animate-spin"})}):e?(0,s.jsxs)("div",{className:"min-h-screen bg-background",children:[(0,s.jsx)(_,{user:e}),(0,s.jsx)("main",{className:"container mx-auto py-6 space-y-6",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[(0,s.jsxs)("div",{className:"lg:col-span-1 space-y-6",children:[(0,s.jsx)(F,{onResults:e=>{o(e),h("lookup")}}),(0,s.jsx)(q,{selectedBills:d,user:e,onWarehouseOpen:f}),(0,s.jsx)(el,{user:e}),(0,s.jsx)(ed,{user:e,selectedBills:d,onSellComplete:()=>{"warehouse"===u&&f(),m([])},onHistoryOpen:g})]}),(0,s.jsx)("div",{className:"lg:col-span-3",children:(0,s.jsx)(e_,{data:i,onSelectionChange:e=>{m(e)},viewMode:u})})]})})]}):null}},8703:function(e,a,t){"use strict";t.d(a,{z:function(){return o}});var s=t(7920),n=t(1335),r=t(2898),l=t(1057),i=t(1967);let c=(0,l.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),o=n.forwardRef((e,a)=>{let{className:t,variant:n,size:l,asChild:o=!1,...d}=e,m=o?r.g7:"button";return(0,s.jsx)(m,{className:(0,i.cn)(c({variant:n,size:l,className:t})),ref:a,...d})});o.displayName="Button"},6700:function(e,a,t){"use strict";t.d(a,{Ol:function(){return i},SZ:function(){return o},Zb:function(){return l},aY:function(){return d},ll:function(){return c}});var s=t(7920),n=t(1335),r=t(1967);let l=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("div",{ref:a,className:(0,r.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",t),...n})});l.displayName="Card";let i=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("div",{ref:a,className:(0,r.cn)("flex flex-col space-y-1.5 p-6",t),...n})});i.displayName="CardHeader";let c=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("h3",{ref:a,className:(0,r.cn)("text-2xl font-semibold leading-none tracking-tight",t),...n})});c.displayName="CardTitle";let o=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("p",{ref:a,className:(0,r.cn)("text-sm text-muted-foreground",t),...n})});o.displayName="CardDescription";let d=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("div",{ref:a,className:(0,r.cn)("p-6 pt-0",t),...n})});d.displayName="CardContent",n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("div",{ref:a,className:(0,r.cn)("flex items-center p-6 pt-0",t),...n})}).displayName="CardFooter"},2626:function(e,a,t){"use strict";t.d(a,{X:function(){return c}});var s=t(7920),n=t(1335),r=t(3702),l=t(7102),i=t(1967);let c=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(r.fC,{ref:a,className:(0,i.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t),...n,children:(0,s.jsx)(r.z$,{className:(0,i.cn)("flex items-center justify-center text-current"),children:(0,s.jsx)(l.Z,{className:"h-4 w-4"})})})});c.displayName=r.fC.displayName},1538:function(e,a,t){"use strict";t.d(a,{I:function(){return l}});var s=t(7920),n=t(1335),r=t(1967);let l=n.forwardRef((e,a)=>{let{className:t,type:n,...l}=e;return(0,s.jsx)("input",{type:n,className:(0,r.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...l})});l.displayName="Input"},6292:function(e,a,t){"use strict";t.d(a,{_:function(){return o}});var s=t(7920),n=t(1335),r=t(5547),l=t(1057),i=t(1967);let c=(0,l.j)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),o=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(r.f,{ref:a,className:(0,i.cn)(c(),t),...n})});o.displayName=r.f.displayName},6767:function(e,a,t){"use strict";t.d(a,{pm:function(){return u}});var s=t(1335);let n=0,r=new Map,l=e=>{if(r.has(e))return;let a=setTimeout(()=>{r.delete(e),d({type:"REMOVE_TOAST",toastId:e})},1e6);r.set(e,a)},i=(e,a)=>{switch(a.type){case"ADD_TOAST":return{...e,toasts:[a.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===a.toast.id?{...e,...a.toast}:e)};case"DISMISS_TOAST":{let{toastId:t}=a;return t?l(t):e.toasts.forEach(e=>{l(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===t||void 0===t?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===a.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==a.toastId)}}},c=[],o={toasts:[]};function d(e){o=i(o,e),c.forEach(e=>{e(o)})}function m(e){let{...a}=e,t=(n=(n+1)%Number.MAX_SAFE_INTEGER).toString(),s=()=>d({type:"DISMISS_TOAST",toastId:t});return d({type:"ADD_TOAST",toast:{...a,id:t,open:!0,onOpenChange:e=>{e||s()}}}),{id:t,dismiss:s,update:e=>d({type:"UPDATE_TOAST",toast:{...e,id:t}})}}function u(){let[e,a]=s.useState(o);return s.useEffect(()=>(c.push(a),()=>{let e=c.indexOf(a);e>-1&&c.splice(e,1)}),[e]),{...e,toast:m,dismiss:e=>d({type:"DISMISS_TOAST",toastId:e})}}},3445:function(e,a,t){"use strict";t.d(a,{O:function(){return s}});let s=(0,t(2552).eI)("your_supabase_project_url_here","your_supabase_anon_key_here")},1967:function(e,a,t){"use strict";t.d(a,{a6:function(){return c},cn:function(){return r},lb:function(){return l},p6:function(){return i}});var s=t(2856),n=t(7660);function r(){for(var e=arguments.length,a=Array(e),t=0;t<e;t++)a[t]=arguments[t];return(0,n.m6)((0,s.W)(a))}function l(e){let a=(null!=e?e:"").toString().replace(/\D/g,"");if(!a)return"0 ₫";try{return(BigInt(a)/100000n).toLocaleString("vi-VN")+" ₫"}catch(e){return Math.floor(Number(a)/1e5).toLocaleString("vi-VN")+" ₫"}}function i(e){if(!e)return"";try{return new Date(e).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch(a){return e}}function c(e){return parseInt((e+"").replace(/\D/g,""),10)||0}}},function(e){e.O(0,[531,282,590,169,94,749,422,744],function(){return e(e.s=9218)}),_N_E=e.O()}]);